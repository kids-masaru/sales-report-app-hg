{% extends "base.html" %}
{% block content %}
<div class="card">
    <form method="POST" action="/process" enctype="multipart/form-data" onsubmit="showLoading()">

        <!-- Modern File Upload Area (Compact) -->
        <div class="file-upload-wrapper">
            <input type="file" name="audio_file" class="file-upload-input"
                accept=".mp3,.wav,.m4a,.webm,.aac,.flac,.ogg">
            <div class="file-upload-content">
                <i class="fas fa-microphone-alt file-upload-icon"></i>
                <div class="file-upload-text">音声 / ファイルを選択</div>
            </div>
        </div>

        <!-- Mode Toggle -->
        <div style="display:flex; gap:10px; margin-bottom:20px; background:#e5e7eb; padding:4px; border-radius:12px;">
            <input type="radio" name="mode" value="sales" id="mode_sales" checked style="display:none;"
                onchange="updateModeUI()">
            <label for="mode_sales" id="label_sales"
                style="flex:1; text-align:center; padding:10px; border-radius:10px; background:white; font-weight:bold; color:var(--primary); transition:all 0.2s;">
                <i class="fas fa-briefcase"></i> 活動記録
            </label>

            <input type="radio" name="mode" value="qa" id="mode_qa" style="display:none;" onchange="updateModeUI()">
            <label for="mode_qa" id="label_qa"
                style="flex:1; text-align:center; padding:10px; border-radius:10px; color:var(--text-sub); font-weight:bold; transition:all 0.2s;">
                <i class="fas fa-comments"></i> 質疑応答
            </label>
        </div>

        <!-- Client Search -->
        <div class="input-group">
            <label><i class="fas fa-building"></i> クライアント名 (検索)</label>
            <div style="position:relative;">
                <input type="text" id="clientSearchInput" placeholder="会社名を入力して検索..." autocomplete="off">
                <input type="hidden" name="client_id" id="client_id">
                <input type="hidden" name="client_name" id="client_name">
                <div id="searchResults"
                    style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ddd; border-radius:8px; max-height:200px; overflow-y:auto; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                </div>
            </div>
        </div>

        <!-- Staff Select (Moved up for quick access) -->
        <div class="input-group">
            <label><i class="fas fa-user-tie"></i> 対応者</label>
            <div style="position:relative;">
                <select name="staff_name" id="staffSelect">
                    {% for staff in staff_options %}
                    <option value="{{ staff }}" {% if staff=="水野 邦彦" %}selected{% endif %}>{{ staff }}</option>
                    {% endfor %}
                </select>
                <i class="fas fa-chevron-down"
                    style="position:absolute; right:12px; top:14px; color:var(--text-sub); pointer-events:none; font-size:0.8rem;"></i>
            </div>
        </div>

        <!-- Text Area -->
        <div class="input-group">
            <label><i class="fas fa-pen"></i> メモ (任意)</label>
            <textarea name="text_input" placeholder="訪問先や内容のメモ..." style="height: 80px;"></textarea>
        </div>

        <button type="submit" class="btn-primary">
            <i class="fas fa-robot"></i> AIが記録を作成
        </button>
    </form>
</div>

<script>
    // Persistent Staff Selection
    document.addEventListener('DOMContentLoaded', function () {
        const staffSelect = document.getElementById('staffSelect');
        const STORAGE_KEY = 'sales_report_last_staff';

        if (staffSelect) {
            // Restore
            const lastStaff = localStorage.getItem(STORAGE_KEY);
            if (lastStaff) {
                staffSelect.value = lastStaff;
            }

            // Save on change and submit
            const saveStaff = () => localStorage.setItem(STORAGE_KEY, staffSelect.value);
            staffSelect.addEventListener('change', saveStaff); // Optional immediate save
            staffSelect.form.addEventListener('submit', saveStaff);
        }

        // Mode UI Toggle
        window.updateModeUI = function () {
            const isSales = document.getElementById('mode_sales').checked;
            document.getElementById('label_sales').style.background = isSales ? 'white' : 'transparent';
            document.getElementById('label_sales').style.color = isSales ? 'var(--primary)' : 'var(--text-sub)';

            document.getElementById('label_qa').style.background = !isSales ? 'white' : 'transparent';
            document.getElementById('label_qa').style.color = !isSales ? 'var(--primary)' : 'var(--text-sub)';
        }

        // Client Search Logic
        const clientInput = document.getElementById('clientSearchInput');
        const resultsDiv = document.getElementById('searchResults');
        let debounceTimer;

        if (clientInput) {
            clientInput.addEventListener('input', function () {
                clearTimeout(debounceTimer);
                const query = this.value;
                if (query.length < 2) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    fetch(`/api/search_clients?q=${encodeURIComponent(query)}`)
                        .then(res => res.json())
                        .then(data => {
                            resultsDiv.innerHTML = '';
                            if (data.length === 0) {
                                resultsDiv.style.display = 'none';
                                return;
                            }
                            data.forEach(client => {
                                const div = document.createElement('div');
                                div.style.padding = '10px';
                                div.style.borderBottom = '1px solid #eee';
                                div.textContent = client.name;
                                div.onclick = () => {
                                    clientInput.value = client.name;
                                    document.getElementById('client_id').value = client.record_id; // Using record_id for Kintone
                                    document.getElementById('client_name').value = client.name;
                                    resultsDiv.style.display = 'none';
                                };
                                resultsDiv.appendChild(div);
                            });
                            resultsDiv.style.display = 'block';
                        });
                }, 300);
            });

            // Hide results on click outside
            document.addEventListener('click', function (e) {
                if (e.target !== clientInput && e.target !== resultsDiv) {
                    resultsDiv.style.display = 'none';
                }
            });
        }
    });
</script>
{% endblock %}