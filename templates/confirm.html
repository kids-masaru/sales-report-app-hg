{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>抽出結果の確認</h2>
    <form method="POST" action="/save" onsubmit="showLoading()">
        <input type="hidden" name="file_path" value="{{ file_path }}">

        <!-- Staff Selection (Editable) -->
        {% if mode != 'qa' %}
        <div style="background:#fef3c7; padding:12px; border-radius:8px; margin-bottom:15px; border:1px solid #fcd34d;">
            <label style="color:#92400e; font-size:0.85rem; font-weight:bold;"><i class="fas fa-user-tie"></i>
                担当者</label>
            <select name="staff_name" style="margin-top:5px;">
                {% for staff in staff_options %}
                <option value="{{ staff }}" {% if staff==staff_name %}selected{% endif %}>{{ staff }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <!-- Client Name (Editable with Search) -->
        {% if mode != 'qa' %}
        <div style="background:#f0f9ff; padding:12px; border-radius:8px; margin-bottom:15px; border:1px solid #bae6fd;">
            <label style="color:#0369a1; font-size:0.85rem; font-weight:bold;"><i class="fas fa-building"></i>
                クライアント名</label>
            <div style="position:relative;">
                <input type="text" id="clientSearchInputConfirm" value="{{ data.get('取引先名', '') }}"
                    placeholder="会社名を入力して検索..." autocomplete="off" style="margin-top:5px;">
                <input type="hidden" name="取引先ID" id="client_id_confirm" value="{{ data.get('取引先ID', '') }}">
                <input type="hidden" name="取引先名" id="client_name_confirm" value="{{ data.get('取引先名', '') }}">
                <div id="searchResultsConfirm"
                    style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ddd; border-radius:8px; max-height:200px; overflow-y:auto; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.1);">
                </div>
            </div>
        </div>
        {% endif %}

        {% for key, value in data.items() %}
        {% if key != '取引先ID' and key != '取引先名' %}
        <label>{{ key }}</label>
        {% if key == "qa_list" %}
        <div style="background:#f9fafb; padding:15px; border-radius:8px; border:1px solid #e5e7eb;">
            {% for item in value %}
            <div style="margin-bottom:15px; border-bottom:1px dashed #ccc; padding-bottom:10px;">
                <div style="font-weight:bold; color:#0369a1; margin-bottom:5px;">Q. {{ item.question }}</div>
                <div style="line-height:1.6;">A. {{ item.answer }}</div>
            </div>
            {% endfor %}
        </div>
        <!-- Raw data hidden just in case -->
        <textarea name="{{ key }}" style="display:none;">{{ value | tojson }}</textarea>
        {% elif key in ["商談内容", "現在の課題・問題点", "競合・マーケット情報"] %}
        <textarea name="{{ key }}">{{ value }}</textarea>
        {% elif key == "新規営業件名" or key == "次回営業件名" %}
        <select name="{{ key }}">
            <option value="">(未選択)</option>
            {% for opt in sales_options %}
            <option value="{{ opt }}" {% if opt==value %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
        </select>
        {% else %}
        <input type="text" name="{{ key }}" value="{{ value }}">
        {% endif %}
        {% endif %}
        {% endfor %}

        <div style="margin-top: 20px;">
            {% if mode != 'qa' %}
            <button type="submit" class="btn-primary">Kintoneに登録</button>
            {% else %}
            <a href="/" class="btn-primary"
                style="display:inline-block; text-decoration:none; background:#888;">トップに戻る</a>
            {% endif %}
        </div>
    </form>
    <div style="text-align:center; margin-top:15px;">
        <a href="/" style="color:#888; text-decoration:none;">戻る（破棄）</a>
    </div>
</div>

<script>
    // Client Search Logic for Confirm Page
    document.addEventListener('DOMContentLoaded', function () {
        const clientInput = document.getElementById('clientSearchInputConfirm');
        const resultsDiv = document.getElementById('searchResultsConfirm');
        const clientIdInput = document.getElementById('client_id_confirm');
        const clientNameInput = document.getElementById('client_name_confirm');
        let debounceTimer;

        if (clientInput) {
            clientInput.addEventListener('input', function () {
                clearTimeout(debounceTimer);
                const query = this.value;

                // Update hidden field as user types
                clientNameInput.value = query;

                if (query.length < 2) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                debounceTimer = setTimeout(() => {
                    fetch(`/api/search_clients?q=${encodeURIComponent(query)}`)
                        .then(res => res.json())
                        .then(data => {
                            resultsDiv.innerHTML = '';
                            if (data.length === 0) {
                                resultsDiv.style.display = 'none';
                                return;
                            }
                            data.forEach(client => {
                                const div = document.createElement('div');
                                div.style.padding = '10px';
                                div.style.borderBottom = '1px solid #eee';
                                div.style.cursor = 'pointer';
                                div.textContent = client.name;
                                div.onclick = () => {
                                    clientInput.value = client.name;
                                    clientIdInput.value = client.record_id;
                                    clientNameInput.value = client.name;
                                    resultsDiv.style.display = 'none';
                                };
                                resultsDiv.appendChild(div);
                            });
                            resultsDiv.style.display = 'block';
                        });
                }, 300);
            });

            // Hide results on click outside
            document.addEventListener('click', function (e) {
                if (e.target !== clientInput && e.target !== resultsDiv) {
                    resultsDiv.style.display = 'none';
                }
            });
        }
    });
</script>
{% endblock %}